---
applyTo: "frontend/**/*.py"
lastUpdated: "2026-02-26"
---
<!-- Generated by .github/agents/ pipeline — do not hand-edit except Overrides section -->

## Purpose
Core library for Django Fast Frontend. Contains the site registry, `ModelFrontend` base class, views, forms, URL routing, accounts, and templatetags. This is the PyPI-distributed package.

## Architecture Flow
```
FrontendConfig.ready() → site.autodiscover_modules() → imports {app}/frontend.py → @register stores in _registry

GET /<app>/<model>/ → FrontendModelView.get()
  → _check_global_auth(request)
  → site.get_model_config(model) → _registry[model].__class__(model=model)
  → model_config.queryset(request) → search → filter → sort → pagination
  → site.http_model_response() → render frontend/site.html

POST /<app>/<model>/<action>/<id> → FrontendModelView.post()
  → auth checks → site.get_model_config(model)
  → table_add: form.save() | table_change: form.save(instance) | table_delete: object.delete()
  → toolbar/inline dispatch: validate action in declared tuple → getattr(config, action)()
  → _safe_redirect(request)
```

## Key Files
| File | Responsibility | Lines | Key Exports |
|---|---|---|---|
| `frontend/__init__.py` | Package entry — re-exports public API | 7 | `site`, `ModelFrontend`, `Config`, `FrontendSite`, `register`, `AccountFrontend` |
| `frontend/sites/model.py` | ModelFrontend base class (user extends this) | 149 | `ModelFrontend` |
| `frontend/sites/site.py` | Site singleton + registry + rendering | 59 | `FrontendSite`, `site` |
| `frontend/sites/config.py` | Global config (brand, auth, CSS) | 22 | `Config` |
| `frontend/sites/abstract.py` | Abstract bases for site + frontend | 108 | `FrontendAbstract`, `FrontendSiteAbstract` |
| `frontend/sites/decorators.py` | `@register(Model)` decorator | 15 | `register` |
| `frontend/views.py` | All HTTP view logic | 323 | `FrontendModelView`, auth views |
| `frontend/forms.py` | Dynamic ModelForm generation | 35 | `generate_form_for_model` |
| `frontend/apps.py` | AppConfig with autodiscovery + URL injection | 37 | `FrontendConfig` |
| `frontend/frontend.py` | Default Config subclass, auto-registers | 14 | `Frontend` |
| `frontend/accounts.py` | AccountSite with account URL patterns | 10 | `AccountSite`, `site` |

## Inheritance & Patterns
```
FrontendAbstract (ABC)
  → ModelFrontend (+ NotImplementedMixin) — USER EXTENDS THIS
  → Config — global settings, authentication property
  → AccountFrontend — marker class for accounts

FrontendSiteAbstract (ABC) — _registry, register(), autodiscover, urls, http_response
  → FrontendSite — get_model_config(), http_home_response(), http_model_response()
```
Registration: `@frontend.register(Model)` → `site.register(model, cls)` → `_registry[model] = cls()`

## Do / Never
- **DO**: Always set `fields` explicitly on `ModelFrontend` — *empty fields logs warning, never defaults to `__all__`*
- **DO**: Override `get_queryset(request)` for row-level authorization
- **DO**: Use `_safe_redirect()` for all POST redirects
- **NEVER**: Use `fields = "__all__"` — *enforced by `test_security.py::TestFormFieldSafety`*
- **NEVER**: Dispatch actions without checking `toolbar_button`/`inline_button` tuples first
- **NEVER**: Access `site._registry` directly from views — use `site.get_model_config()`

## Common Tasks
### Add a new configurable setting to Config
1. Add class attribute with default in `frontend/sites/config.py::Config`
2. Read from Django settings in `frontend/frontend.py::Frontend` via `getattr(settings, 'FRONTEND_*', default)`
3. Access in views via `site.get_global_config()` → attribute access

### Add a new view action type
1. Add handling in `FrontendModelView.post()` in `frontend/views.py`
2. Validate action name against a declared tuple on `ModelFrontend`
3. Add security test in `frontend/tests/test_security.py`

## Testing
- Run: `python -m pytest frontend/tests/ -v`
- Security tests: `frontend/tests/test_security.py` — uses `RequestFactory`, `MagicMock`, `unittest.mock.patch`
- Must use `@pytest.mark.django_db` for DB access

## Gotchas
- **Invalid form on POST**: `form.is_valid()` fails → `form.save()` skipped → `_safe_redirect()` sends user back → **no error message shown, user input lost**
- **Unknown POST action**: Falls through all action checks → silent `HttpResponseRedirect(fallback_url)` — no 400/404
- **Non-callable toolbar/inline action**: Only a `logger.warning()` — user sees a redirect with no error
- **ModelFrontend not cached**: `site.get_model_config(model)` creates a new instance per call — don't store request-scoped state

## Overrides
